{% extends "base.html" %}
{% block title %}RistoSmart FM / Gestione Clienti{% endblock %}

{% block content %}
{% include "_navbar.html" %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<!-- Toast container -->
<div id="toastHost" class="toast-container position-fixed top-0 end-0 p-3" style="z-index:1080;"></div>

<div class="container py-3">
  <h2 class="mb-3" style="color:#003366;">üë• Gestione Clienti</h2>

  <!-- Toolbar -->
  <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
    <input id="search" class="form-control" placeholder="Cerca per nome, email o telefono" style="max-width:360px">
    
    <!-- Bottone Newsletter -->
    <button type="button" id="btnNewsletter" class="btn btn-outline-primary btn-sm ms-auto" disabled>
      üì∞ Newsletter
    </button>
  </div>  

  <!-- Form di inserimento -->
  <form id="form-add" class="row g-2 align-items-center mb-3" autocomplete="off">
    <div class="col-12 col-md-3">
      <input class="form-control" id="nome" placeholder="Nome/Ragione sociale *" required>
    </div>
    <div class="col-12 col-md-3">
      <input class="form-control" id="telefono" placeholder="Telefono">
    </div>
    <div class="col-12 col-md-3">
      <input class="form-control" id="email" type="email" placeholder="Email">
    </div>
    <div class="col-12 col-md-3">
      <div class="d-flex gap-2">
        <input class="form-control" id="note" placeholder="Note">
        <button class="btn btn-primary" id="btnAdd" type="submit" title="Aggiungi cliente">‚ûï</button>
      </div>
    </div>
  </form>

  <p class="text-muted small mt-2 mb-0">
    I dati vengono salvati <strong>immediatamente</strong> in LocalStorage e sincronizzati 
    <strong>automaticamente</strong> con il Database.
  </p>

  <!-- Tabella -->
  <div class="table-responsive">
    <table class="table table-sm align-middle">
      <thead class="table-light">
      <tr>
        <th style="width:34px">
          <input id="selAll" type="checkbox" title="Seleziona tutti">
        </th>
        <th style="width:26%">Nome</th>
        <th style="width:18%">Telefono</th>
        <th style="width:26%">Email</th>
        <th>Note</th>
        <th style="width:110px" class="text-end">Azioni</th>
      </tr>
    </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>  
</div>

<style>
  .action-btn { border:none; background:transparent; font-size:1.1rem; line-height:1; padding:6px; }
  .action-btn:hover { opacity:.8; }
  td input.form-control { height: 34px; padding: 4px 8px; }
  .toast { border-radius:10px; }
  .toast .toast-body { font-weight:500; }
</style>

<script>
(() => {
  const UID = window.USER_ID || "anon";
  const LS_KEY = `${UID}_clienti_v1`;
  const SEL_KEY = `${UID}_newsletter_selection`;

  const $ = sel => document.querySelector(sel);
  const tbody = $("#tbody");
  const search = $("#search");  
  const btnNewsletter = $("#btnNewsletter");
  const selAll = $("#selAll");

  // ‚Äî‚Äî‚Äî Util
  const getCSRF = () => document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ?? null;
  const headersJSON = () => {
    const h = { "Content-Type": "application/json" };
    const csrf = getCSRF(); 
    if (csrf) h["X-CSRF-Token"] = csrf;   // nome coerente con @require_csrf
    return h;
  };
  const uid = () => "tmp_" + Math.random().toString(36).slice(2,9);
  const saveLS = arr => localStorage.setItem(LS_KEY, JSON.stringify(arr||[]));
  const loadLS = () => { try { return JSON.parse(localStorage.getItem(LS_KEY)||"[]"); } catch { return []; } };
  
  function showToast(text, type="success"){
    const host = document.getElementById("toastHost"); if(!host) return;
    const bg = {success:"bg-success", warning:"bg-warning text-dark", danger:"bg-danger", info:"bg-info text-dark"}[type] || "bg-secondary";
    const el = document.createElement("div");
    el.className = `toast align-items-center ${bg} text-white show`;
    el.setAttribute("role","alert"); el.setAttribute("aria-live","assertive"); el.setAttribute("aria-atomic","true");
    el.innerHTML = `<div class="d-flex"><div class="toast-body">‚úîÔ∏è ${text}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" aria-label="Close"></button></div>`;
    el.querySelector(".btn-close").addEventListener("click", ()=>{ el.classList.remove("show"); setTimeout(()=>el.remove(),150); });
    host.appendChild(el); setTimeout(()=>{ el.classList.remove("show"); setTimeout(()=>el.remove(),200); },3200);
  }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  // ‚Äî‚Äî‚Äî Selezioni Newsletter
  let selected = new Set(JSON.parse(localStorage.getItem(SEL_KEY) || "[]").map(String));
  function persistSelected(){ localStorage.setItem(SEL_KEY, JSON.stringify([...selected])); }
  function updateNewsletterBtn(){
    const count = selected.size;
    btnNewsletter.disabled = count === 0;
    btnNewsletter.textContent = count ? `üì® Newsletter (${count})` : "üì® Newsletter";
  }

  // ‚Äî‚Äî‚Äî API
  async function apiList(){
    const r = await fetch("/api/clienti", {credentials:"same-origin"});
    if(!r.ok) throw new Error("GET /api/clienti");
    return r.json();
  }
  async function apiAdd(data){
    const r = await fetch("/api/clienti", { method:"POST", headers: headersJSON(), credentials:"same-origin", body: JSON.stringify(data) });
    if(!r.ok) throw new Error("POST /api/clienti");
    return r.json();
  }
  async function apiUpdate(id, data){
    const r = await fetch(`/api/clienti/${id}`, { method:"PUT", headers: headersJSON(), credentials:"same-origin", body: JSON.stringify(data) });
    if(!r.ok) throw new Error("PUT /api/clienti/"+id);
    return r.json();
  }
  async function apiDelete(id){
      const r = await fetch(`/api/clienti/${id}`, { 
          method:"DELETE", 
          headers: headersJSON(),   // üîí aggiunto CSRF token
          credentials:"same-origin" 
      });
      if(!r.ok) throw new Error("DELETE /api/clienti/"+id);
      return true;
  }

  // ‚Äî‚Äî‚Äî Stato
  let clienti = [];

  // ‚Äî‚Äî‚Äî Bootstrap
  (async function boot(){
    try {
      const fromSrv = await apiList();
      clienti = Array.isArray(fromSrv) ? fromSrv : (fromSrv.items || []);
      saveLS(clienti);
    } catch {
      clienti = loadLS();
    }
    renderRows(clienti);
  })();

  // ‚Äî‚Äî‚Äî Render
  function renderRows(list){
    const q = (search.value||"").trim().toLowerCase();
    const filtered = !q ? list : list.filter(c =>
      (c.nome||"").toLowerCase().includes(q) ||
      (c.email||"").toLowerCase().includes(q) ||
      (c.telefono||"").toLowerCase().includes(q)
    );
    tbody.innerHTML = filtered.map(c => `
      <tr data-id="${c.id}">
        <td>
          <input type="checkbox" class="row-check" data-id="${c.id}" ${selected.has(String(c.id)) ? "checked" : ""}>
        </td>
        <td class="c-nome">${escapeHtml(c.nome||"")}</td>
        <td class="c-telefono">${escapeHtml(c.telefono||"")}</td>
        <td class="c-email">${escapeHtml(c.email||"")}</td>
        <td class="c-note">${escapeHtml(c.note||"")}</td>
        <td class="text-end">
          <button class="action-btn btn-edit" title="Modifica">‚úèÔ∏è</button>
          <button class="action-btn btn-save d-none" title="Salva">üíæ</button>
          <button class="action-btn btn-del" title="Elimina">üóëÔ∏è</button>
        </td>
      </tr>
    `).join("");

    // aggiorna "seleziona tutto" in base ai filtrati visibili
    const visibleIds = filtered.map(c => String(c.id));
    const allVisibleSelected = visibleIds.length>0 && visibleIds.every(id => selected.has(id));
    if (selAll) selAll.checked = allVisibleSelected;

    updateNewsletterBtn();
  }

  // ‚Äî‚Äî‚Äî Ricerca live
  let t; search.addEventListener("input", () => { clearTimeout(t); t = setTimeout(()=>renderRows(clienti), 120); });

  // ‚Äî‚Äî‚Äî Aggiunta
  $("#form-add").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const data = {
      nome: $("#nome").value.trim(),
      telefono: $("#telefono").value.trim(),
      email: $("#email").value.trim(),
      note: $("#note").value.trim()
    };
    if(!data.nome){ $("#nome").focus(); return; }

    // Inserimento ottimistico
    const tempId = uid();
    const tempObj = { id: tempId, ...data };
    clienti.unshift(tempObj);
    saveLS(clienti);
    renderRows(clienti);
    e.target.reset();

    try{
      const saved = await apiAdd(data);
      const i = clienti.findIndex(c=>c.id===tempId);
      if(i>=0){
        clienti[i] = { ...tempObj, ...saved };
        saveLS(clienti);
        renderRows(clienti);
      }
      showToast("Cliente salvato nel DB.", "success");
    }catch{
      showToast("Salvato offline. Sincronizzo quando torni online.", "warning");
    }
  });

  // ‚Äî‚Äî‚Äî Deleghe tabelle: edit/save/delete
  tbody.addEventListener("click", async (ev)=>{
    const btn = ev.target.closest("button"); if(!btn) return;
    const tr = btn.closest("tr"); const id = tr?.dataset?.id; if(!id) return;

    if(btn.classList.contains("btn-edit")){
      toEditMode(tr); return;
    }

    if(btn.classList.contains("btn-save")){
      const data = fromEditMode(tr); if(!data) return;

      const idx = clienti.findIndex(c=>String(c.id)===String(id));
      if(idx>=0){ clienti[idx] = { ...clienti[idx], ...data }; saveLS(clienti); renderRows(clienti); }

      if(!String(id).startsWith("tmp_")){
        try { await apiUpdate(id, data); showToast("Modifiche salvate nel DB.", "success"); }
        catch { showToast("Modifiche salvate solo offline. Ritento dopo.", "warning"); }
      } else {
        try{
          const saved = await apiAdd(data);
          const j = clienti.findIndex(c=>String(c.id)===String(id));
          if(j>=0){ clienti[j] = { ...clienti[j], ...saved }; saveLS(clienti); renderRows(clienti); }
          showToast("Record sincronizzato nel DB.", "success");
        }catch{ showToast("Salvataggio rimasto offline (record temporaneo).", "warning"); }
      }
      return;
    }

    if(btn.classList.contains("btn-del")){
      if(!confirm("Eliminare questo cliente?")) return;

      // Rimuovi subito da LS/UI
      clienti = clienti.filter(c=>String(c.id)!==String(id));
      saveLS(clienti);
      // Pulisci selezione Newsletter
      selected.delete(String(id));
      persistSelected();
      renderRows(clienti);
      updateNewsletterBtn();

      // DB
      if(!String(id).startsWith("tmp_")){
        try { await apiDelete(id); showToast("Cliente eliminato dal DB.", "success"); }
        catch { showToast("Eliminato solo in locale. Ritento dopo.", "warning"); }
      }
      return;
    }
  });

  // Toggle per riga
  tbody.addEventListener("change", (e)=>{
    const cb = e.target.closest(".row-check"); if(!cb) return;
    const id = String(cb.dataset.id);
    if (cb.checked) selected.add(id); else selected.delete(id);
    persistSelected(); updateNewsletterBtn();
  });

  // Seleziona tutti i visibili
  selAll?.addEventListener("change", ()=>{
    const checked = selAll.checked;
    const q = (search.value||"").trim().toLowerCase();
    const filtered = !q ? clienti : clienti.filter(c =>
      (c.nome||"").toLowerCase().includes(q) ||
      (c.email||"").toLowerCase().includes(q) ||
      (c.telefono||"").toLowerCase().includes(q)
    );
    filtered.forEach(c=>{
      const id = String(c.id);
      if (checked) selected.add(id); else selected.delete(id);
    });
    persistSelected();
    renderRows(clienti);
  });

  // Pulsante Newsletter
  btnNewsletter?.addEventListener("click", (e)=>{
    e.preventDefault(); e.stopPropagation();
    if (btnNewsletter.disabled || selected.size === 0) return;
    persistSelected();
    window.location.href = "{{ url_for('newsletter_page') }}";
  });

  // Sanifica selezione rispetto alla lista corrente
  selected = new Set([...selected].filter(id => clienti.some(c => String(c.id)===id)));
  persistSelected(); updateNewsletterBtn();

  function toEditMode(tr){
    const tdN = tr.querySelector(".c-nome");
    const tdT = tr.querySelector(".c-telefono");
    const tdE = tr.querySelector(".c-email");
    const tdNo= tr.querySelector(".c-note");
    tdN.innerHTML = `<input class="form-control" value="${tdN.textContent}">`;
    tdT.innerHTML = `<input class="form-control" value="${tdT.textContent}">`;
    tdE.innerHTML = `<input class="form-control" type="email" value="${tdE.textContent}">`;
    tdNo.innerHTML= `<input class="form-control" value="${tdNo.textContent}">`;
    tr.querySelector(".btn-edit").classList.add("d-none");
    tr.querySelector(".btn-save").classList.remove("d-none");
  }

  function fromEditMode(tr){
    const getVal = sel => tr.querySelector(sel+" input")?.value.trim() ?? "";
    const data = { nome: getVal(".c-nome"), telefono: getVal(".c-telefono"), email: getVal(".c-email"), note: getVal(".c-note") };
    if(!data.nome){ alert("Il nome √® obbligatorio."); return null; }
    tr.querySelector(".c-nome").textContent = data.nome;
    tr.querySelector(".c-telefono").textContent = data.telefono;
    tr.querySelector(".c-email").textContent = data.email;
    tr.querySelector(".c-note").textContent = data.note;
    tr.querySelector(".btn-edit").classList.remove("d-none");
    tr.querySelector(".btn-save").classList.add("d-none");
    return data;
  }

  // Online/offline
  window.addEventListener("online",  ()=>{ tryResync(); });
  window.addEventListener("offline", ()=>{ /* nessuna azione */ });

  async function tryResync(){
    try{
      const srv = await apiList();
      const list = Array.isArray(srv) ? srv : (srv.items || []);
      clienti = list; saveLS(clienti); renderRows(clienti);
      showToast("Sincronizzazione completata.", "info");
    }catch{}
  }
})();  // chiusura IIFE
</script>

{% endblock %}
